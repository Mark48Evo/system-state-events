{"version":3,"file":"system-state-events.js","sources":["../src/index.js"],"sourcesContent":["import pmx from 'pmx';\nimport Debug from 'debug';\nimport amqplib from 'amqplib';\nimport { createClient } from 'redis';\nimport SystemEvents from '@mark48evo/system-events';\nimport SystemState from '@mark48evo/system-state';\n\npmx.init({});\n\nconst statesProcessed = pmx.probe().counter({\n  name: 'State Changes Processed',\n});\n\nconst statesProcessedPerMin = pmx.probe().meter({\n  name: 'req/min',\n  samples: 1,\n  timeframe: 60,\n});\n\nconst debug = Debug('system:state:events');\n\nconst config = {\n  host: process.env.RABBITMQ_HOST || 'amqp://localhost',\n  redisURL: process.env.REDIS_URL || 'redis://127.0.0.1:6379/3',\n};\n\nasync function main() {\n  const connect = await amqplib.connect(config.host);\n  const channel = await connect.createChannel();\n  const redis = createClient(config.redisURL);\n\n  const systemEvents = await SystemEvents(channel, { consume: false });\n  const systemState = await SystemState(redis, channel);\n\n  debug('Init Completed');\n\n  systemState.on('*', async (stateName, value) => {\n    debug(`Published \"state.change\" for state: \"${stateName}\"`);\n    statesProcessed.inc();\n    statesProcessedPerMin.mark();\n\n    systemEvents.publish('state.change', {\n      stateName,\n      value,\n    });\n  });\n}\n\nmain().catch(e => console.error(e));\n"],"names":["pmx","init","statesProcessed","probe","counter","statesProcessedPerMin","meter","debug","Debug","config","process","env","RABBITMQ_HOST","REDIS_URL","main","connect","amqplib","host","channel","createChannel","redis","createClient","redisURL","systemEvents","SystemEvents","systemState","SystemState","on","stateName","value","inc","mark","publish","catch","e","console","error"],"mappings":";;;;;;;;;;;;AAOAA,IAAIC,IAAJ,CAAS,EAAT;AAEA,MAAMC,kBAAkBF,IAAIG,KAAJ,GAAYC,OAAZ,CAAoB;QACpC;CADgB,CAAxB;AAIA,MAAMC,wBAAwBL,IAAIG,KAAJ,GAAYG,KAAZ,CAAkB;QACxC,SADwC;WAErC,CAFqC;aAGnC;CAHiB,CAA9B;AAMA,MAAMC,QAAQC,MAAM,qBAAN,CAAd;AAEA,MAAMC,SAAS;QACPC,QAAQC,GAAR,CAAYC,aAAZ,IAA6B,kBADtB;YAEHF,QAAQC,GAAR,CAAYE,SAAZ,IAAyB;CAFrC;;AAKA,eAAeC,IAAf,GAAsB;QACdC,UAAU,MAAMC,QAAQD,OAAR,CAAgBN,OAAOQ,IAAvB,CAAtB;QACMC,UAAU,MAAMH,QAAQI,aAAR,EAAtB;QACMC,WAAQC,mBAAaZ,OAAOa,QAApB,CAAd;QAEMC,eAAe,MAAMC,aAAaN,OAAb,EAAsB;aAAW;GAAjC,CAA3B;QACMO,cAAc,MAAMC,YAAYN,QAAZ,EAAmBF,OAAnB,CAA1B;QAEM,gBAAN;cAEYS,EAAZ,CAAe,GAAf,EAAoB,OAAOC,SAAP,EAAkBC,KAAlB,KAA4B;UACvC,wCAAuCD,SAAU,GAAxD;oBACgBE,GAAhB;0BACsBC,IAAtB;iBAEaC,OAAb,CAAqB,cAArB,EAAqC;eAAA;;KAArC;GALF;;;AAYFlB,OAAOmB,KAAP,CAAaC,KAAKC,QAAQC,KAAR,CAAcF,CAAd,CAAlB"}